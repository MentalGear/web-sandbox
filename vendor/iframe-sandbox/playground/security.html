<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Security Research Host</title>
    <style>
        body { font-family: monospace; background: #121212; color: #e0e0e0; padding: 20px; }
        #logs { white-space: pre-wrap; margin-top: 20px; border-top: 1px solid #333; padding-top: 10px; }
        .log-entry { margin-bottom: 4px; }
        .log-error { color: #ff5555; }
        .log-warn { color: #ffb74d; }
        .log-info { color: #4caf50; }
    </style>
</head>
<body>
    <h1>ðŸ¤– Automated Security Research Host</h1>
    <p>Global API <code>window.SandboxControl</code> is available for automation.</p>

    <!-- The Sandbox Instance -->
    <safe-sandbox id="sandbox" sandbox-origin="http://sandbox.localhost:3333" cacheStrategy="network-only"></safe-sandbox>

    <div id="logs">Waiting for logs...</div>

    <script type="module" src="/src/lib/SafeSandbox.ts"></script>
    <script type="module">
        try {
            console.log("[Host] Initializing SandboxControl...");
            const sandbox = document.getElementById('sandbox');
            const logsDiv = document.getElementById('logs');
            const capturedLogs = [];

            // --- Log Capture ---
            sandbox.addEventListener('log', (event) => {
                const data = event.detail;
                const logEntry = {
                    timestamp: Date.now(),
                    source: data.source || data.depth || 'host',
                    level: data.level || data.logType || 'log',
                    area: data.area || '',
                    message: data.message || (data.args ? data.args.join(' ') : '')
                };

                capturedLogs.push(logEntry);

                // Visual feedback (optional for headless, but good for debugging)
                const div = document.createElement('div');
                div.className = `log-entry log-${logEntry.level}`;
                div.textContent = `[${logEntry.source}:${logEntry.area}] ${logEntry.message}`;
                logsDiv.prepend(div);
            });

            // --- Automation API ---
            window.SandboxControl = {
                // Reference to the raw element
                sandboxElement: sandbox,

                // Execute arbitrary code in the sandbox
                execute: (code) => {
                    console.log("[Host] Executing code...");
                    sandbox.execute(code);
                },

                // Set Network Rules (JSON object)
                // e.g. { allow: ["google.com"], scriptUnsafe: true }
                setNetworkRules: (rules) => {
                    console.log("[Host] Setting rules:", rules);
                    sandbox.setNetworkRules(rules);
                },

                // Load a specific URL into the inner frame (replaces src)
                loadSrc: (url) => {
                    console.log("[Host] loading src:", url);
                    const code = `
                        console.log("Loading: ${url}");
                        fetch("${url}").then(r => r.text()).then(html => {
                            document.open(); document.write(html); document.close();
                        }).catch(e => console.error(e));
                    `;
                    sandbox.execute(code);
                },

                // Get all captured logs programmatically
                getLogs: () => {
                    return capturedLogs;
                },

                // Clear captured logs
                clearLogs: () => {
                    capturedLogs.length = 0;
                    logsDiv.innerHTML = '';
                },

                // reset
                reset: () => {
                   const sandboxOrigin = sandbox.getAttribute('sandbox-origin') || 'http://sandbox.localhost:3333';
                   const iframe = sandbox.shadowRoot.querySelector('iframe');
                   if(iframe) iframe.src = iframe.src;
                }
            };

            console.log("[Host] SandboxControl available on window.");
            const info = document.createElement('div');
            info.className = 'log-info';
            info.textContent = "SandboxControl initialized and ready.";
            logsDiv.appendChild(info);

            // Notify ready
            sandbox.addEventListener('ready', () => {
                console.log("[Host] Sandbox Ready");
                capturedLogs.push({ source: 'host', level: 'info', message: 'Sandbox Ready' });
            });
        } catch (e) {
            console.error("[Host] Setup failed:", e);
            document.getElementById('logs').innerHTML += `<div class="log-error">Setup failed: ${e.message}</div>`;
        }
    </script>
</body>
</html>
