<!DOCTYPE html>
<html>
<head>
    <title>Virtual Files Hub</title>
</head>
<body>
    <script>
        let messageQueue = [];
        let isReady = false;

        // Register SW
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.ts')
                .then(reg => {
                    console.log("[Hub] SW Registered");

                    const checkController = () => {
                        if (navigator.serviceWorker.controller) {
                            isReady = true;
                            console.log("[Hub] SW Ready (Controller Active)");
                            flushQueue();
                        }
                    };

                    if (reg.active && navigator.serviceWorker.controller) {
                        checkController();
                    } else {
                        navigator.serviceWorker.addEventListener('controllerchange', checkController);
                    }
                })
                .catch(err => console.error("[Hub] SW Registration Failed", err));
        }

        function flushQueue() {
            while (messageQueue.length > 0) {
                const event = messageQueue.shift();
                processMessage(event);
            }
        }

        function processMessage(event) {
            if (event.data?.type === 'PUT_FILES') {
                const { sessionId, files } = event.data;
                console.log("[Hub] Received files for", sessionId);

                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'PUT_FILES',
                        sessionId,
                        files
                    });
                } else {
                    console.warn("[Hub] Lost message (Race condition)");
                }
            }
        }

        // Listen for messages from Host
        window.addEventListener('message', (event) => {
            if (!isReady) {
                console.log("[Hub] Queuing message...");
                messageQueue.push(event);
            } else {
                processMessage(event);
            }
        });
    </script>
</body>
</html>
